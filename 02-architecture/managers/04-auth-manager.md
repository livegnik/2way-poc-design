



# 04 Auth Manager

Defines local authentication resolution for HTTP and WebSocket entrypoints.
Specifies authentication outputs used to construct [OperationContext](../services-and-apps/05-operation-context.md).
Defines auth lifecycle, rejection categories, and audit requirements.


## 1. Invariants and guarantees

Across all relevant components and execution contexts defined in this file, the following invariants hold:

* Authentication is strictly separated from authorization in accordance with [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).
* Authentication never implies permission, visibility, or ownership.
* [Auth Manager](04-auth-manager.md) never mutates backend graph state.
* [Auth Manager](04-auth-manager.md) never accesses private keys or performs cryptographic operations, keeping cryptographic enforcement with the actors defined in [01-protocol/04-cryptography.md](../../01-protocol/04-cryptography.md).
* [Auth Manager](04-auth-manager.md) never trusts client-supplied identity claims, consistent with the prohibition on inferred identity in [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).
* Every request produces exactly one explicit authentication outcome.
* Authentication results are deterministic given identical session store state.
* `[OperationContext](../services-and-apps/05-operation-context.md).requester_identity_id` is bound exclusively by [Auth Manager](04-auth-manager.md) so that the HTTP layer can provide the context described in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).
* Envelope-declared authorship is never overridden or inferred by [Auth Manager](04-auth-manager.md), matching the authorship guarantees in [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).
* All guarantees hold regardless of caller, execution context, or input source.

## 2. Authentication lifecycle and execution phases

[Auth Manager](04-auth-manager.md) operates as a pure execution engine with explicit phases. These phases are derived from legacy architecture flows and remain valid.

### 2.1 Input acquisition

* Receive raw request metadata from HTTP or WebSocket layer defined in [04-interfaces/**](../../04-interfaces/).
* Extract session token from header or cookie.
* Receive trusted route classification and app context from the interface layer.
* Treat all extracted data as untrusted input.

### 2.2 Token validation

* Validate token presence.
* Validate token format.
* Validate token existence in frontend session store.
* Validate token expiry.
* Resolve linked frontend user record.
* Resolve linked backend identity.

Any failure terminates execution and produces a rejected authentication result.

### 2.3 Admin gating evaluation

* Executed only after successful authentication.
* Apply admin-only route constraints if applicable.
* Determine admin eligibility from trusted local configuration or identity metadata.
* Failure produces a rejected authentication result.

### 2.4 Authentication result emission

* Produce a complete authentication result.
* Bind identity and flags for [OperationContext](../services-and-apps/05-operation-context.md) construction.
* Emit audit signals where required.
* Return control to interface layer.

## 3. Authentication inputs and outputs

### 3.1 Inputs

#### 3.1.1 HTTP entrypoints

* Session token from header or cookie.
* Trusted route classification.
* App context resolved by routing layer.

#### 3.1.2 WebSocket entrypoints

* Session token supplied during connection establishment.

All inputs are untrusted.

### 3.2 Outputs

[Auth Manager](04-auth-manager.md) produces an authentication result containing:

* `requester_identity_id`, integer or null.
* Authentication state, authenticated, unauthenticated, or rejected.
* Admin eligibility flag.
* Rejection category.

### 3.3 OperationContext construction requirements

The interface layer MUST construct an [OperationContext](../services-and-apps/05-operation-context.md) only after [Auth Manager](04-auth-manager.md) success, matching the lifecycle defined in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).

Requirements:

* `requester_identity_id` set exactly as produced by [Auth Manager](04-auth-manager.md).
* `app_id` supplied from trusted routing logic.
* `is_remote` set to false, reflecting the local submission posture in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).
* `trace_id` generated by the interface layer.
* Remote-only fields unset.
* Context treated as immutable after construction.

Requests lacking sufficient metadata to build a valid [OperationContext](../services-and-apps/05-operation-context.md) are rejected so that downstream validation may apply the ordering defined in [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).

## 4. Session token model

### 4.1 Authority and ownership

* Frontend database is the sole session authority for local requests referenced in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).
* Each token maps to exactly one session record.
* Each session maps to exactly one frontend user.
* Each frontend user maps to exactly one backend identity.

[Auth Manager](04-auth-manager.md) does not cache session resolutions.

### 4.2 Validation requirements

For authenticated endpoints, [Auth Manager](04-auth-manager.md) validates:

* Token presence.
* Token format.
* Token existence.
* Token expiry.
* User record integrity.
* Backend identity existence.

Failure of any check results in rejection.

### 4.3 Unauthenticated access

* Public endpoints may proceed with `requester_identity_id = null`.
* All other endpoints require authentication.
* Public access is explicit, never inferred.

## 5. Admin gating

### 5.1 Semantics

* Admin gating is evaluated after authentication.
* Admin eligibility is required only for explicitly marked routes.

### 5.2 Constraints

* Admin status does not bypass ACL evaluation per [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).
* Admin status does not grant implicit permissions.
* Admin gating applies only to route-level constraints.

## 6. Interaction with other components

### 6.1 HTTP layer

Inputs:

* Session token.
* Route classification.
* App context.

Outputs:

* Authentication result for [OperationContext](../services-and-apps/05-operation-context.md).

Trust boundary:

* HTTP layer supplies metadata but never identity assertions, consistent with [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).

### 6.2 WebSocket layer

* Authentication occurs at connection establishment.
* Unauthenticated connections are rejected.
* Rejected connections receive no events.

### 6.3 Storage access

* [Auth Manager](04-auth-manager.md) reads frontend session and user records through approved interfaces.
* [Auth Manager](04-auth-manager.md) never accesses backend graph tables or raw SQLite connections.

### 6.4 Downstream managers

* Identity binding flows only through `[OperationContext](../services-and-apps/05-operation-context.md)`.
* [Graph Manager](07-graph-manager.md) enforces authorship and ownership independently per [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).
* [ACL Manager](06-acl-manager.md) performs all authorization checks regardless of authentication outcome per [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).

## 7. Failure handling and rejection behavior

### 7.1 Failure posture

* Fail closed.
* Reject on ambiguity, inconsistency, or unavailability, following the posture in [01-protocol/10-errors-and-failure-modes.md](../../01-protocol/10-errors-and-failure-modes.md).

### 7.2 Rejection categories

At minimum:

* Missing token.
* Malformed token.
* Unknown token.
* Expired token.
* Session store unavailable.
* User record missing.
* Backend identity missing.
* Admin gating failure.

These categories map to the canonical classification ordering in [01-protocol/10-errors-and-failure-modes.md](../../01-protocol/10-errors-and-failure-modes.md).

### 7.3 Session store unavailability

* All authenticated endpoints rejected.
* Admin endpoints always rejected.
* Public endpoints proceed only if explicitly allowed.

### 7.4 Abuse posture

* Authentication failures may be logged with aggregation.
* No rate limiting or puzzles implemented here.
* Abuse mitigation owned elsewhere.

## 8. Security constraints specific to Auth Manager

### 8.1 Identity isolation

* Client-supplied identity claims are ignored, reflecting the prohibition on inferred identity in [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).
* Session linkage is the only authoritative identity source for local submissions as described in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).

### 8.2 Privilege containment

* Authentication does not imply authorization per [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).
* App identity and user identity remain distinct inputs.

### 8.3 Auditability

* Authentication and admin gating failures are observable via [Log Manager](12-log-manager.md).
* [Auth Manager](04-auth-manager.md) does not emit graph objects.

### 8.4 Local-only scope

* [Auth Manager](04-auth-manager.md) never processes remote traffic.
* Remote identities are introduced exclusively by [Network Manager](10-network-manager.md) and [State Manager](09-state-manager.md) per [01-protocol/08-network-transport-requirements.md](../../01-protocol/08-network-transport-requirements.md).
