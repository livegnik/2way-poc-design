



# 04 Auth Manager

Defines local authentication resolution for HTTP and WebSocket entrypoints. Specifies authentication outputs used to construct [OperationContext](../services-and-apps/05-operation-context.md). Defines auth lifecycle, rejection categories, and audit requirements.

For the meta specifications, see [04-auth-manager meta](../../10-appendix/meta/02-architecture/managers/04-auth-manager-meta.md).

## 1. Invariants and guarantees

Across all relevant components and execution contexts defined in this file, the following invariants hold:

* Authentication is strictly separated from authorization in accordance with [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).
* Authentication never implies permission, visibility, or ownership.
* [Auth Manager](04-auth-manager.md) never mutates backend graph state.
* [Auth Manager](04-auth-manager.md) never accesses private keys and never performs signing or decryption, keeping private-key enforcement with the actors defined in [01-protocol/04-cryptography.md](../../01-protocol/04-cryptography.md). It may verify signatures using public keys for auth registration.
* [Auth Manager](04-auth-manager.md) never trusts client-supplied identity claims, consistent with the prohibition on inferred identity in [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).
* Every request produces exactly one explicit authentication outcome.
* Authentication results are deterministic given identical auth token store state.
* `[OperationContext](../services-and-apps/05-operation-context.md).requester_identity_id` is bound exclusively by [Auth Manager](04-auth-manager.md) so that the HTTP layer can provide the context described in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).
* Envelope-declared authorship is never overridden or inferred by [Auth Manager](04-auth-manager.md), matching the authorship guarantees in [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).
* All guarantees hold regardless of caller, execution context, or input source.

## 2. Authentication lifecycle and execution phases

[Auth Manager](04-auth-manager.md) operates as a pure execution engine with explicit phases. These phases are derived from legacy architecture flows and remain valid.

### 2.1 Input acquisition

* Receive raw request metadata from HTTP or WebSocket layer defined in [04-interfaces/**](../../04-interfaces/).
* Extract auth token from header or cookie.
* Receive trusted route classification and app context from the interface layer.
* Treat all extracted data as untrusted input.

### 2.2 Token validation

* Validate token presence.
* Validate token format.
* Validate token existence in backend auth token store.
* Validate token expiry.
* Validate token revocation status.
* Resolve linked backend identity.

Any failure terminates execution and produces a rejected authentication result.

### 2.3 Admin gating evaluation

* Executed only after successful authentication.
* Apply admin-only route constraints if applicable.
* Determine admin eligibility by verifying the requester identity holds the admin capability defined by `auth.admin_capability` (default `system.admin`).
* Failure produces a rejected authentication result.

### 2.4 Authentication result emission

* Produce a complete authentication result.
* Bind identity and flags for [OperationContext](../services-and-apps/05-operation-context.md) construction.
* Emit audit signals where required.
* Return control to interface layer.

## 3. Authentication inputs and outputs

### 3.1 Inputs

#### 3.1.1 HTTP entrypoints

* Auth token from header or cookie.
* Trusted route classification.
* App context resolved by routing layer.

#### 3.1.2 WebSocket entrypoints

* Auth token supplied during connection establishment.

All inputs are untrusted.

### 3.2 Outputs

[Auth Manager](04-auth-manager.md) produces an authentication result containing:

* `requester_identity_id`, integer or null.
* Authentication state, authenticated, unauthenticated, or rejected.
* Admin eligibility flag.
* Rejection category.

### 3.3 OperationContext construction requirements

The interface layer MUST construct an [OperationContext](../services-and-apps/05-operation-context.md) only after [Auth Manager](04-auth-manager.md) success, matching the lifecycle defined in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).

Requirements:

* `requester_identity_id` set exactly as produced by [Auth Manager](04-auth-manager.md).
* `app_id` supplied from trusted routing logic.
* `is_remote` set to false, reflecting the local submission posture in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).
* `trace_id` generated by the interface layer.
* Remote-only fields unset.
* Context treated as immutable after construction.

Requests lacking sufficient metadata to build a valid [OperationContext](../services-and-apps/05-operation-context.md) are rejected so that downstream validation may apply the ordering defined in [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).

## 4. Auth token model

### 4.1 Authority and ownership

* Backend auth token store is the sole authority for local requests referenced in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).
* Each token maps to exactly one auth token record.
* Each auth token maps to exactly one backend identity.
* Auth tokens MUST NOT be stored in graph tables.
* Issuing a new token for an identity MUST revoke all previously issued tokens for that identity.

[Auth Manager](04-auth-manager.md) does not cache auth token resolutions.

### 4.2 Validation requirements

For authenticated endpoints, [Auth Manager](04-auth-manager.md) validates:

* Token presence.
* Token format.
* Token existence.
* Backend identity existence.
* Token expiry and revocation status.

Failure of any check results in rejection.

### 4.3 Unauthenticated access

* Public endpoints may proceed with `requester_identity_id = null`.
* All other endpoints require authentication.
* Public access is explicit, never inferred.

### 4.4 Registration signature verification

For `/auth/identity/register`:

* Verify the signature over the canonical payload per [04-interfaces/13-auth-session.md](../../04-interfaces/13-auth-session.md).
* Bind the resulting identity solely to the submitted public key.
* Registration is idempotent for a given public key.
* Enforce replay protection for `nonce` and `timestamp` values and persist accepted nonces for the configured replay window.
* Persist replay protection entries in the `auth_registration_nonces` system table.

## 5. Admin gating

### 5.1 Semantics

* Admin gating is evaluated after authentication.
* Admin eligibility is required only for explicitly marked routes.

### 5.2 Constraints

* Admin status does not bypass schema or app/domain constraints per [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).
* Admin actions (explicitly marked admin-only routes) bypass object-level ACL checks per [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).
* Admin gating applies only to route-level constraints.

## 6. Interaction with other components

### 6.1 HTTP layer

Inputs:

* Session token.
* Route classification.
* App context.

Outputs:

* Authentication result for [OperationContext](../services-and-apps/05-operation-context.md).

Trust boundary:

* HTTP layer supplies metadata but never identity assertions, consistent with [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).

### 6.2 WebSocket layer

* Authentication occurs at connection establishment.
* Unauthenticated connections are rejected.
* Rejected connections receive no events.

### 6.3 Storage access

* [Auth Manager](04-auth-manager.md) reads auth token records through approved interfaces.
* [Auth Manager](04-auth-manager.md) never accesses backend graph tables or raw SQLite connections.

### 6.4 Downstream managers

* Identity binding flows only through `[OperationContext](../services-and-apps/05-operation-context.md)`.
* [Graph Manager](07-graph-manager.md) enforces authorship and ownership independently per [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).
* [ACL Manager](06-acl-manager.md) performs all authorization checks regardless of authentication outcome per [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).

## 7. Failure handling and rejection behavior

### 7.1 Failure posture

* Fail closed.
* Reject on ambiguity, inconsistency, or unavailability, following the posture in [01-protocol/10-errors-and-failure-modes.md](../../01-protocol/10-errors-and-failure-modes.md).

### 7.2 Rejection categories

At minimum:

* Missing token.
* Malformed token.
* Unknown token.
* Expired token.
* Revoked token.
* Auth token store unavailable.
* Backend identity missing.
* Admin gating failure.
* Registration signature invalid (for auth registration).
* Registration replay detected (for auth registration).

### 7.4 Mapping to ErrorDetail

Auth Manager rejection categories map to `ErrorDetail.code` values as follows (transport status in parentheses):

* Missing token -> `auth_required` (401)
* Malformed token -> `auth_invalid` (401)
* Unknown token -> `auth_invalid` (401)
* Expired token -> `ERR_AUTH_TOKEN_EXPIRED` (401)
* Revoked token -> `ERR_AUTH_TOKEN_REVOKED` (401)
* Auth token store unavailable -> `auth_invalid` (401)
* Backend identity missing -> `auth_invalid` (401)
* Admin gating failure -> `acl_denied` (400)
* Registration signature invalid -> `ERR_AUTH_SIGNATURE_INVALID` (401)
* Registration replay or skew -> `ERR_AUTH_REPLAY` (401)

These categories map to the canonical classification ordering in [01-protocol/10-errors-and-failure-modes.md](../../01-protocol/10-errors-and-failure-modes.md).

### 7.3 Auth token store unavailability

* All authenticated endpoints rejected.
* Admin endpoints always rejected.
* Public endpoints proceed only if explicitly allowed.

### 7.4 Abuse posture

* Authentication failures may be logged with aggregation.
* No rate limiting or puzzles implemented here.
* Abuse mitigation owned elsewhere.

## 8. Security constraints specific to Auth Manager

### 8.1 Identity isolation

* Client-supplied identity claims are ignored, reflecting the prohibition on inferred identity in [01-protocol/05-keys-and-identity.md](../../01-protocol/05-keys-and-identity.md).
* Session linkage is the only authoritative identity source for local submissions as described in [01-protocol/00-protocol-overview.md](../../01-protocol/00-protocol-overview.md).

### 8.2 Privilege containment

* Authentication does not imply authorization per [01-protocol/06-access-control-model.md](../../01-protocol/06-access-control-model.md).
* App identity and user identity remain distinct inputs.

### 8.3 Auditability

* Authentication and admin gating failures are observable via [Log Manager](12-log-manager.md).
* [Auth Manager](04-auth-manager.md) does not emit graph objects.

### 8.4 Local-only scope

* [Auth Manager](04-auth-manager.md) never processes remote traffic.
* Remote identities are introduced exclusively by [Network Manager](10-network-manager.md) and [State Manager](09-state-manager.md) per [01-protocol/08-network-transport-requirements.md](../../01-protocol/08-network-transport-requirements.md).

## 9. Configuration surface, `auth.*`

[Auth Manager](04-auth-manager.md) owns the `auth.*` namespace in [Config Manager](01-config-manager.md).

| Key | Type | Reloadable | Default | Description |
| --- | --- | --- | --- | --- |
| `auth.admin_capability` | String | Yes | `system.admin` | Capability name that grants admin eligibility for admin-gated routes. |
| `auth.registration.max_skew_ms` | Integer | Yes | `300000` | Maximum absolute clock skew for registration timestamps (ms). |
| `auth.registration.nonce_ttl_ms` | Integer | Yes | `600000` | Replay window for `(public_key, nonce)` acceptance (ms). |
| `auth.token.ttl_ms` | Integer | Yes | `86400000` | Default auth token time-to-live (ms). |
